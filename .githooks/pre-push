#!/bin/bash
# Pre-push hook: Run tests before pushing

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ§ª Running pre-push checks...${NC}\n"

# Get the remote name and URL being pushed to
remote="$1"
url="$2"

echo -e "${BLUE}Remote: ${NC}$remote"
echo -e "${BLUE}URL: ${NC}$url\n"

# Run Ruff (quick final check)
echo -e "${BLUE}1ï¸âƒ£  Running Ruff linter (quick check)...${NC}"
if uv run ruff check src/ tests/; then
    echo -e "${GREEN}âœ“ Ruff passed${NC}\n"
else
    echo -e "${RED}âœ— Ruff found issues${NC}"
    echo -e "${YELLOW}Run 'uv run ruff check src/ tests/ --fix' to auto-fix${NC}\n"
    exit 1
fi

# Run Black (quick final check)
echo -e "${BLUE}2ï¸âƒ£  Running Black formatter (quick check)...${NC}"
if uv run black src/ tests/ --check --quiet; then
    echo -e "${GREEN}âœ“ Black formatting passed${NC}\n"
else
    echo -e "${RED}âœ— Black found formatting issues${NC}"
    echo -e "${YELLOW}Run 'uv run black src/ tests/' to format${NC}\n"
    exit 1
fi

# Run tests
echo -e "${BLUE}3ï¸âƒ£  Running unit tests...${NC}"
if uv run pytest -v; then
    echo -e "${GREEN}âœ“ All tests passed${NC}\n"
else
    TEST_EXIT=$?
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âœ— Tests failed${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Please fix the failing tests before pushing${NC}"
    echo -e "${YELLOW}Run 'uv run pytest -v' to see detailed output${NC}\n"
    exit $TEST_EXIT
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ“ All pre-push checks passed! Pushing...${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

exit 0